rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Validate string length
    function isValidString(value, minLen, maxLen) {
      return value is string &&
        value.size() >= minLen &&
        value.size() <= maxLen;
    }
    
    // Validate display name (alphanumeric + spaces, 3-20 chars)
    function isValidDisplayName(name) {
      return name is string &&
        name.size() >= 3 &&
        name.size() <= 20 &&
        name.matches('^[a-zA-Z0-9 _-]+$');
    }
    
    // Valid game IDs
    function isValidGameId(gameId) {
      return gameId in [
        'snake', 'pacman', 'tetris', 'breakout', 
        'asteroids', 'minesweeper', '2048', 'tictactoe'
      ];
    }
    
    // Validate score data
    function isValidScore() {
      return request.resource.data.score is number 
        && request.resource.data.score >= 0
        && request.resource.data.score <= 100000000
        && request.resource.data.gameId is string
        && isValidGameId(request.resource.data.gameId)
        && request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // USERS - User profile and stats
    // ============================================
    
    match /users/{userId} {
      // Allow anyone to read user profiles
      allow read: if true;
      allow create: if isSignedIn() && isOwner(userId)
        && isValidDisplayName(request.resource.data.displayName);
      allow update: if isOwner(userId)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['displayName']) 
            || isValidDisplayName(request.resource.data.displayName));
      allow delete: if false;
    }
    
    // ============================================
    // USER STATS - Best scores per user per game
    // ============================================
    
    match /userStats/{docId} {
      allow read: if true;
      allow create: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$')
        && request.resource.data.keys().hasOnly([
          'userId', 'gameId', 'bestScore', 'gamesPlayed', 'lastPlayed'
        ]);
      allow update: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$');
      allow delete: if false;
    }
    
    // ============================================
    // SCORES - All submitted game scores
    // ============================================
    
    match /scores/{scoreId} {
      allow read: if true;
      
      allow create: if isSignedIn() 
        && isValidScore()
        && request.resource.data.keys().hasOnly([
          'gameId', 'score', 'userId', 'displayName', 'avatar',
          'timestamp', 'sessionId', 'duration', 'metadata', 'verified'
        ]);
      
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // ACHIEVEMENTS - Global achievement definitions
    // ============================================
    
    match /achievements/{achievementId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // USER ACHIEVEMENTS - User achievement progress
    // ============================================
    
    match /userAchievements/{docId} {
      allow read: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$');
      allow create: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$')
        && request.resource.data.keys().hasOnly([
          'userId', 'achievementId', 'progress', 'unlocked', 
          'unlockedAt', 'updatedAt'
        ]);
      allow update: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$');
      allow delete: if false;
    }
    
    // ============================================
    // CHALLENGES - Active challenge definitions
    // ============================================
    
    match /challenges/{challengeId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // USER CHALLENGES - User challenge progress
    // ============================================
    
    match /userChallenges/{docId} {
      allow read: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$');
      allow create: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$')
        && request.resource.data.keys().hasOnly([
          'userId', 'challengeId', 'progress', 'completed',
          'completedAt', 'claimed', 'updatedAt'
        ]);
      allow update: if isSignedIn() 
        && docId.matches('^' + request.auth.uid + '_.+$');
      allow delete: if false;
    }
    
    // ============================================
    // SHOP ITEMS - Shop item definitions
    // ============================================
    
    match /shopItems/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // USER INVENTORY - User purchased items
    // ============================================
    
    match /userInventory/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'items', 'equipped', 'updatedAt'
        ]);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // ============================================
    // TOURNAMENTS
    // ============================================
    
    match /tournaments/{tournamentId} {
      allow read: if true;
      
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          'name', 'game', 'description', 'maxParticipants',
          'startTime', 'prize', 'createdBy', 'participants',
          'status', 'createdAt'
        ])
        && isValidString(request.resource.data.name, 3, 50)
        && request.resource.data.createdBy == request.auth.uid;
      
      allow update: if isSignedIn() 
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['participants', 'updatedAt', 'status', 'winner']);
      
      allow delete: if isSignedIn() 
        && resource.data.createdBy == request.auth.uid;
    }
    
    // ============================================
    // TOURNAMENT PARTICIPANTS
    // ============================================
    
    match /tournamentParticipants/{docId} {
      allow read: if true;
      allow create: if isSignedIn() 
        && docId.matches('^.+_' + request.auth.uid + '$')
        && request.resource.data.keys().hasOnly([
          'userId', 'tournamentId', 'displayName', 'photoURL',
          'score', 'joinedAt', 'updatedAt'
        ]);
      allow update: if isSignedIn() 
        && docId.matches('^.+_' + request.auth.uid + '$');
      allow delete: if false;
    }
    
    // ============================================
    // FRIENDS SYSTEM
    // ============================================
    
    match /friends/{friendshipId} {
      // Allow read for any signed in user (filtered in app)
      allow read: if isSignedIn();
      // Allow create for any authenticated user
      allow create: if isSignedIn();
      allow update: if false;
      // Allow delete if user is part of the friendship
      allow delete: if isSignedIn() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );
    }
    
    match /friendRequests/{requestId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() 
        && request.resource.data.fromUserId == request.auth.uid;
      allow update: if isSignedIn() && (
        resource.data.toUserId == request.auth.uid ||
        resource.data.fromUserId == request.auth.uid
      );
      allow delete: if isSignedIn() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
    }
    
    // ============================================
    // PRESENCE - Online status
    // ============================================
    
    match /presence/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // ============================================
    // PUBLIC PROFILES
    // ============================================
    
    match /publicProfiles/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
    
    // ============================================
    // MESSAGING SYSTEM
    // ============================================
    
    match /conversations/{conversationId} {
      allow read: if isSignedIn() && 
        resource.data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() 
        && request.resource.data.participants.hasAny([request.auth.uid]);
      allow update: if isSignedIn() && 
        resource.data.participants.hasAny([request.auth.uid]);
      allow delete: if false;
    }
    
    match /messages/{messageId} {
      allow read: if isSignedIn() && 
        get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants.hasAny([request.auth.uid]);
      allow create: if isSignedIn() 
        && request.resource.data.senderId == request.auth.uid
        && get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.participants.hasAny([request.auth.uid]);
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // PARTY SYSTEM
    // ============================================
    
    match /parties/{partyId} {
      // Any signed-in user can read — required so a user can query by code to join.
      // Party codes are shared manually between friends so this is acceptable.
      allow read: if isSignedIn();

      allow create: if isSignedIn()
        && request.resource.data.leaderId == request.auth.uid;

      allow update: if isSignedIn() && (
        // Party leader can update anything
        resource.data.leaderId == request.auth.uid
        ||
        // Existing members can update (ready status, etc.)
        resource.data.memberIds.hasAny([request.auth.uid])
        ||
        // A non-member may join when the party is still open:
        //  · party must be in 'waiting' status
        //  · party must have fewer than 8 members
        //  · caller must not already be in memberIds
        //  · new memberIds must be a strict superset (no removals allowed)
        //  · new memberIds must include the caller
        (
          resource.data.status == 'waiting'
          && resource.data.members.size() < 8
          && !resource.data.memberIds.hasAny([request.auth.uid])
          && request.resource.data.memberIds.hasAll(resource.data.memberIds)
          && request.resource.data.memberIds.hasAny([request.auth.uid])
        )
      );

      allow delete: if isSignedIn() &&
        resource.data.leaderId == request.auth.uid;
    }
    
    match /partyMessages/{messageId} {
      allow read: if isSignedIn() && 
        get(/databases/$(database)/documents/parties/$(resource.data.partyId)).data.memberIds.hasAny([request.auth.uid]);
      allow create: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // ADMIN COLLECTION
    // ============================================
    
    match /admins/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if false;
    }
  }
}
