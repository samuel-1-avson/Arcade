rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Validate string length
    function isValidString(value, minLen, maxLen) {
      return value is string &&
        value.size() >= minLen &&
        value.size() <= maxLen;
    }
    
    // Validate display name (alphanumeric + spaces, 3-20 chars)
    function isValidDisplayName(name) {
      return name is string &&
        name.size() >= 3 &&
        name.size() <= 20 &&
        name.matches('^[a-zA-Z0-9 _-]+$');
    }
    
    // Validate score data
    function isValidScore() {
      return request.resource.data.score is number 
        && request.resource.data.score >= 0
        && request.resource.data.score <= 100000000
        && request.resource.data.gameId is string
        && request.resource.data.gameId.size() > 0
        && request.resource.data.userId == request.auth.uid;
    }
    
    // Validate chat message
    function isValidMessage() {
      return request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 500
        && request.resource.data.from == request.auth.uid;
    }
    
    // Validate timestamp
    function hasValidTimestamp() {
      return request.time == request.time; // Always true, ensures request.time exists
    }
    
    // Rate limiting helper (checks if user has submitted too many scores recently)
    function isRateLimited() {
      // This is handled by Cloud Functions, but we add basic validation here
      return true;
    }
    
    // ============================================
    // PRIVATE USER DATA
    // Only the owner can access their own private data
    // ============================================
    
    match /users/{userId} {
      // Only owner can read/write their own private data
      allow read: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId)
        && isValidDisplayName(request.resource.data.displayName);
      allow update: if isOwner(userId)
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['displayName']) 
            || isValidDisplayName(request.resource.data.displayName));
      allow delete: if false; // Soft delete only via admin
      
      // Achievements subcollection - private
      match /achievements/{achievementId} {
        allow read, write: if isOwner(userId);
      }
      
      // Game stats subcollection - private
      match /gameStats/{gameId} {
        allow read, write: if isOwner(userId);
      }
      
      // User preferences - private
      match /preferences/{prefId} {
        allow read, write: if isOwner(userId);
      }
      
      // Notifications - private
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================
    // PUBLIC PROFILES
    // Publicly readable, owner-writable with strict validation
    // ============================================
    
    match /publicProfiles/{userId} {
      allow read: if true;
      
      allow create: if isOwner(userId) 
        && request.resource.data.keys().hasOnly([
          'displayName', 'avatar', 'level', 'title', 'titleColor',
          'totalAchievements', 'favoriteGame', 'lastSeen', 'createdAt',
          'isOnline', 'currentGame'
        ])
        && isValidDisplayName(request.resource.data.displayName)
        && request.resource.data.level is number
        && request.resource.data.level >= 1
        && request.resource.data.level <= 100;
      
      allow update: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'displayName', 'avatar', 'level', 'title', 'titleColor',
          'totalAchievements', 'favoriteGame', 'lastSeen',
          'isOnline', 'currentGame'
        ])
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['displayName'])
            || isValidDisplayName(request.resource.data.displayName))
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['level'])
            || (request.resource.data.level is number 
                && request.resource.data.level >= 1 
                && request.resource.data.level <= 100));
      
      allow delete: if false;
    }
    
    // ============================================
    // SCORES
    // Validated writes, Cloud Functions process and verify
    // ============================================
    
    match /scores/{scoreId} {
      allow read: if true;
      
      // Strict validation for score submission
      allow create: if isSignedIn() 
        && isValidScore()
        && request.resource.data.keys().hasOnly([
          'gameId', 'score', 'userId', 'userName', 'userPhoto',
          'timestamp', 'sessionId', 'duration', 'metadata', 'verified'
        ]);
      
      // Only Cloud Functions can update (for verification)
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // LEADERBOARDS
    // Read-only, maintained by Cloud Functions
    // ============================================
    
    match /leaderboards/{gameId} {
      allow read: if true;
      allow write: if false; // Only Cloud Functions
    }
    
    // ============================================
    // ANALYTICS
    // System-only collections
    // ============================================
    
    match /analytics/{eventId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly([
          'type', 'data', 'timestamp', 'userId', 'sessionId'
        ]);
      allow read, update, delete: if false;
    }
    
    match /analytics_counters/{dateId} {
      allow read, write: if false;
    }
    
    match /analytics_daily/{dateId} {
      allow read, write: if false;
    }
    
    match /analytics_processed/{dateId}/events/{eventId} {
      allow read, write: if false;
    }
    
    // ============================================
    // TOURNAMENTS
    // ============================================
    
    match /tournaments/{tournamentId} {
      allow read: if true;
      
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          'id', 'name', 'gameId', 'type', 'size', 'entryFee',
          'startTime', 'createdAt', 'status', 'participants',
          'bracket', 'currentRound', 'results', 'hostId'
        ])
        && isValidString(request.resource.data.name, 3, 50)
        && request.resource.data.hostId == request.auth.uid;
      
      allow update: if isSignedIn() 
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['participants', 'updatedAt', 'status', 'bracket', 'currentRound', 'results']);
      
      allow delete: if isSignedIn() 
        && resource.data.hostId == request.auth.uid;
      
      // Tournament scores subcollection
      match /scores/{scoreId} {
        allow read: if true;
        allow create: if isSignedIn() 
          && request.resource.data.userId == request.auth.uid
          && request.resource.data.keys().hasOnly([
            'userId', 'score', 'tournamentId', 'timestamp'
          ]);
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // TOURNAMENT SCORES (GLOBAL)
    // ============================================
    
    match /tournament_scores/{scoreId} {
      allow read: if true;
      allow create: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasOnly([
          'userId', 'tournamentId', 'score', 'timestamp'
        ]);
      allow update, delete: if false;
    }
    
    // ============================================
    // CHALLENGES
    // ============================================
    
    match /challenges/{type}/{challengeId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ============================================
    // GLOBAL STATS
    // ============================================
    
    match /stats/{statId} {
      allow read: if true;
      allow write: if false;
    }
    
    // ============================================
    // FRIENDS SYSTEM
    // ============================================
    
    match /friends/{friendshipId} {
      allow read: if isSignedIn() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );
      
      allow create: if isSignedIn() && 
        request.resource.data.user1Id == request.auth.uid
        && request.resource.data.keys().hasOnly([
          'user1Id', 'user2Id', 'status', 'createdAt'
        ]);
      
      allow update: if isSignedIn() && (
        resource.data.user1Id == request.auth.uid ||
        resource.data.user2Id == request.auth.uid
      );
      
      allow delete: if false;
    }
    
    match /friendRequests/{requestId} {
      allow read: if isSignedIn() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
      
      allow create: if isSignedIn() && 
        request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.keys().hasOnly([
          'fromUserId', 'toUserId', 'status', 'timestamp'
        ]);
      
      allow update: if isSignedIn() && 
        resource.data.toUserId == request.auth.uid;
      
      allow delete: if isSignedIn() && (
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      );
    }
    
    // ============================================
    // PARTY SYSTEM
    // ============================================
    
    match /parties/{partyId} {
      allow read: if isSignedIn() && 
        request.auth.uid in resource.data.memberIds;
      
      allow create: if isSignedIn()
        && request.resource.data.keys().hasOnly([
          'partyId', 'leaderId', 'memberIds', 'memberNames',
          'createdAt', 'status', 'gameId'
        ])
        && request.resource.data.leaderId == request.auth.uid;
      
      allow update: if isSignedIn() && (
        request.auth.uid in resource.data.memberIds ||
        request.auth.uid == resource.data.leaderId
      );
      
      allow delete: if isSignedIn() && 
        resource.data.leaderId == request.auth.uid;
      
      // Party chat messages
      match /messages/{messageId} {
        allow read: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/parties/$(partyId)).data.memberIds;
        
        allow create: if isSignedIn() && 
          request.auth.uid in get(/databases/$(database)/documents/parties/$(partyId)).data.memberIds &&
          request.resource.data.userId == request.auth.uid &&
          isValidString(request.resource.data.text, 1, 500) &&
          request.resource.data.keys().hasOnly([
            'userId', 'name', 'avatar', 'text', 'timestamp'
          ]);
        
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // PRESENCE / ONLINE STATUS
    // ============================================
    
    match /presence/{userId} {
      allow read: if true;
      allow write: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'online', 'lastSeen', 'currentGame', 'lastChanged'
        ]);
    }
    
    // ============================================
    // NOTIFICATIONS
    // ============================================
    
    match /notifications/{userId}/{notificationId} {
      allow read: if isOwner(userId);
      allow write: if false; // System writes only
    }
    
    // ============================================
    // ADMIN COLLECTION (for admin users)
    // ============================================
    
    match /admins/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if false; // Only manually set in Firebase Console
    }
    
    // ============================================
    // RATE LIMITING
    // Tracks user actions for rate limiting
    // ============================================
    
    match /rateLimits/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Only Cloud Functions
    }
    
    // ============================================
    // USER REPORTS
    // For reporting inappropriate content
    // ============================================
    
    match /reports/{reportId} {
      allow create: if isSignedIn()
        && request.resource.data.reporterId == request.auth.uid
        && request.resource.data.keys().hasOnly([
          'reporterId', 'reportedId', 'reason', 'details', 'timestamp', 'status'
        ]);
      allow read: if isSignedIn() && isOwner(resource.data.reporterId);
      allow update, delete: if false;
    }
  }
}
