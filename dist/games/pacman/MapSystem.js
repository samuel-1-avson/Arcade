/**
 * Pac-Man Map System
 * 15 unique themed maps with different layouts and visual styles
 */

// Base maze dimensions
export const MAZE_COLS = 28;
export const MAZE_ROWS = 31;

// Tile types
export const TILE = {
    EMPTY: 0,
    WALL: 1,
    DOT: 2,
    POWER: 3,
    GHOST_HOUSE: 4,
    TUNNEL: 5,
    FRUIT_SPAWN: 6,
    POWERUP_SPAWN: 7
};

export const MAPS = {
    CLASSIC: {
        id: 'classic',
        name: 'Classic Arcade',
        icon: 'ðŸ•¹ï¸',
        description: 'The original Pac-Man layout',
        theme: {
            background: '#000000',
            wall: '#0000ff',
            wallGlow: '#4444ff',
            dot: '#ffff00',
            power: '#ffff00',
            gridLines: false
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222112222222222221",
            "1211112111112112111121111121",
            "1311112111112112111121111131",
            "1211112111112112111121111121",
            "1222222222222222222222222221",
            "1211112112111111211211112121",
            "1211112112111111211211112121",
            "1222222112222112222211222221",
            "1111112111110110111112111111",
            "0000012111110110111112100000",
            "0000012110000000001112100000",
            "0000012110114441101112100000",
            "1111112110140004101112111111",
            "5000002000140004100002000005",
            "1111112110140004101112111111",
            "0000012110111111101112100000",
            "0000012110000000001112100000",
            "0000012110111111101112100000",
            "1111112110111111101112111111",
            "1222222222222112222222222221",
            "1211112111112112111121111121",
            "1211112111112112111121111121",
            "1322112222222002222222112231",
            "1112112112111111211211211211",
            "1112112112111111211211211211",
            "1222222112222112222211222221",
            "1211111111112112111111111121",
            "1211111111112112111111111121",
            "1222222222222222222222222221",
            "1111111111111111111111111111"
        ]
    },

    NEON_CITY: {
        id: 'neon_city',
        name: 'Neon City',
        icon: 'ðŸŒƒ',
        description: 'Modern cityscape with glowing lights',
        unlocked: true,
        unlockCondition: 'Complete Level 3',
        theme: {
            background: '#0a0015',
            wall: '#ff00ff',
            wallGlow: '#ff66ff',
            dot: '#00ffff',
            power: '#ffff00',
            gridLines: true,
            gridColor: 'rgba(255,0,255,0.1)'
        },
        layout: [
            "1111111111111111111111111111",
            "1222222221111111122222222221",
            "1211111121111111121111111121",
            "1312222121111111121222213121",
            "1211211121111111121112112121",
            "1211222222222222222222112121",
            "1211211111111111111112112121",
            "1222211111111111111112222221",
            "1111211222222222222112111111",
            "0000211211111111121120000000",
            "0000222211111111122220000000",
            "0000211200000000021120000000",
            "0000211201144410021120000000",
            "1111211201400040121121111111",
            "5000222001400040022220000005",
            "1111211201400040121121111111",
            "0000211201111110021120000000",
            "0000222200000000022220000000",
            "0000211211111111121120000000",
            "1111211222222222222121111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111222222222222111111121",
            "1322222211111111112222222231",
            "1111111211111111112111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1211111111112112111111111121",
            "1222222222222222222222222221",
            "1311111111111111111111111131",
            "1111111111111111111111111111"
        ]
    },

    HAUNTED_MANSION: {
        id: 'haunted_mansion',
        name: 'Haunted Mansion',
        icon: 'ðŸšï¸',
        description: 'Spooky corridors and secret passages',
        unlocked: true,
        unlockCondition: 'Eat 20 ghosts',
        theme: {
            background: '#1a0a1a',
            wall: '#4a2a4a',
            wallGlow: '#8844aa',
            dot: '#88ff88',
            power: '#ff4444',
            gridLines: false,
            fogEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222211112222222222221",
            "1211112112211112112111121121",
            "1311112112200002112111121131",
            "1211112112211112112111121121",
            "1222222222222222222222222221",
            "1211111111100001111111112121",
            "1211111111100001111111112121",
            "1222211111100001111112222221",
            "1111211111100001111112111111",
            "0000222221100001122222000000",
            "0000211121100001121112000000",
            "0000211121144441121112000000",
            "1111211121400041121112111111",
            "5000222221400041122222000005",
            "1111211121400041121112111111",
            "0000211121111111121112000000",
            "0000222221000001122222000000",
            "1111211111000001111112111111",
            "1222222211000001112222222221",
            "1211111211000001112111111121",
            "1211111211111111112111111121",
            "1322222222222222222222222231",
            "1111112111111111111211111111",
            "1222222111111111111222222221",
            "1211111222222222222111111121",
            "1211111211111111112111111121",
            "1222222211111111112222222221",
            "1311111111111111111111111131",
            "1222222222222222222222222221",
            "1111111111111111111111111111"
        ]
    },

    SPACE_STATION: {
        id: 'space_station',
        name: 'Space Station',
        icon: 'ðŸš€',
        description: 'Zero-gravity tunnels in outer space',
        unlocked: true,
        unlockCondition: 'Complete 10 levels',
        theme: {
            background: '#000022',
            wall: '#0088ff',
            wallGlow: '#00ccff',
            dot: '#ffffff',
            power: '#ff8800',
            gridLines: true,
            gridColor: 'rgba(0,136,255,0.1)',
            starField: true
        },
        layout: [
            "1111111111111111111111111111",
            "5222222222222222222222222225",
            "1211111111111111111111111121",
            "1312222222222222222222222131",
            "1211111111111111111111111121",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111200000000002111111121",
            "1222222200000000002222222221",
            "1111111200000000002111111111",
            "5000002200000000002200000005",
            "0000002211111111112200000000",
            "0000002211144411112200000000",
            "1111112211400041112211111111",
            "5222222211400041112222222225",
            "1111112211400041112211111111",
            "0000002211111111112200000000",
            "5000002200000000002200000005",
            "1111111200000000002111111111",
            "1222222200000000002222222221",
            "1211111211111111112111111121",
            "1211111211111111112111111121",
            "1322222222222222222222222231",
            "1211111111111111111111111121",
            "1211111111111111111111111121",
            "1222222222222112222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "5222222222222222222222222225",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    CRYSTAL_CAVE: {
        id: 'crystal_cave',
        name: 'Crystal Cave',
        icon: 'ðŸ’Ž',
        description: 'Glittering crystals light your path',
        unlocked: true,
        unlockCondition: 'Score 15,000 points',
        theme: {
            background: '#001122',
            wall: '#00aacc',
            wallGlow: '#00eeff',
            dot: '#aaffff',
            power: '#ff00ff',
            gridLines: false,
            crystalEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222221111111122222222221",
            "1211121121111111121211121121",
            "1311121121111111121211121131",
            "1222222222211112222222222221",
            "1211121111211112111121112121",
            "1211121111211112111121112121",
            "1222222211222221112222222221",
            "1111121211111111121211111111",
            "0000121222222222221210000000",
            "0000121211111111121210000000",
            "0000122211000001122210000000",
            "0000121211014410121210000000",
            "1111121211140041121211111111",
            "5000222221140041122222000005",
            "1111121211140041121211111111",
            "0000121211011110121210000000",
            "0000122200000000022210000000",
            "0000121211111111121210000000",
            "1111121222222222221211111111",
            "1222222211111111112222222221",
            "1211121211111111112111211121",
            "1211121222222222222121211121",
            "1322222211111111112222222231",
            "1111121211111111112121111111",
            "1222222222211112222222222221",
            "1211121111211112111121112121",
            "1311121111211112111121112131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    JUNGLE_TEMPLE: {
        id: 'jungle_temple',
        name: 'Jungle Temple',
        icon: 'ðŸ›ï¸',
        description: 'Ancient ruins full of treasures',
        unlocked: true,
        unlockCondition: 'Collect 500 dots',
        theme: {
            background: '#0a1a0a',
            wall: '#228822',
            wallGlow: '#44cc44',
            dot: '#ffcc00',
            power: '#ff4400',
            gridLines: false,
            vineEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111211111111112111111121",
            "1311111211111111112111111131",
            "1211111211111111112111111121",
            "1222211222222222222112222221",
            "1211211211111111112112112121",
            "1211222211111111112222112121",
            "1211211211111111112112112121",
            "1111211222222222222112111111",
            "0000211211111111112112000000",
            "0000222211111111112222000000",
            "0000211211144411112112000000",
            "1111211211400041112112111111",
            "5000222211400041112222000005",
            "1111211211400041112112111111",
            "0000211211111111112112000000",
            "0000222222222222222222000000",
            "0000211211111111112112000000",
            "1111211222222222222112111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111222222222222111111121",
            "1322222211111111112222222231",
            "1111111211111111112111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    DIGITAL_GRID: {
        id: 'digital_grid',
        name: 'Digital Grid',
        icon: 'ðŸ’»',
        description: 'Tron-style digital landscape',
        unlocked: true,
        unlockCondition: 'Play for 30 minutes total',
        theme: {
            background: '#000011',
            wall: '#00ff88',
            wallGlow: '#00ffaa',
            dot: '#00ccff',
            power: '#ffff00',
            gridLines: true,
            gridColor: 'rgba(0,255,136,0.15)',
            scanlineEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1311111111111111111111111131",
            "1222222222222222222222222221",
            "1211111111122211111111112121",
            "1211111111122211111111112121",
            "1222222221122211222222222221",
            "1111112221122211222111111111",
            "0000112221122211222110000000",
            "0000112221100011222110000000",
            "0000112221100011222110000000",
            "0000112221144411222110000000",
            "1111112221400041222111111111",
            "5000222221400041222220000005",
            "1111112221400041222111111111",
            "0000112221111111222110000000",
            "0000112221100011222110000000",
            "0000112221100011222110000000",
            "1111112221122211222111111111",
            "1222222221122211222222222221",
            "1211111111122211111111111121",
            "1211111111122211111111111121",
            "1322222222222222222222222231",
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    CANDY_LAND: {
        id: 'candy_land',
        name: 'Candy Land',
        icon: 'ðŸ¬',
        description: 'Sweet paths through a sugary world',
        unlocked: true,
        unlockCondition: 'Complete 15 levels',
        theme: {
            background: '#220011',
            wall: '#ff66aa',
            wallGlow: '#ff88cc',
            dot: '#ffffff',
            power: '#44ff44',
            gridLines: false,
            candyEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222221112222222222221",
            "1211112111121112111211112121",
            "1311112111121112111211112131",
            "1211112111121112111211112121",
            "1222222222222222222222222221",
            "1211112111111111111211112121",
            "1211112111111111111211112121",
            "1222222211111111112222222221",
            "1111112211111111112211111111",
            "0000022211111111112220000000",
            "0000022200000000002220000000",
            "0000022201144410022220000000",
            "1111122201400040122211111111",
            "5000222201400040122220000005",
            "1111122201400040122211111111",
            "0000022201111110022220000000",
            "0000022200000000002220000000",
            "0000022211111111112220000000",
            "1111112211111111112211111111",
            "1222222222221112222222222221",
            "1211112111121112111211112121",
            "1211112111121112111211112121",
            "1322222222222222222222222231",
            "1111112111111111111211111111",
            "1222222111111111111222222221",
            "1211112222221112222211112121",
            "1311112111121112111211112131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    PIRATE_SHIP: {
        id: 'pirate_ship',
        name: 'Pirate Ship',
        icon: 'ðŸ´â€â˜ ï¸',
        description: 'Nautical adventure on the high seas',
        unlocked: true,
        unlockCondition: 'Use 10 power-ups',
        theme: {
            background: '#001133',
            wall: '#886633',
            wallGlow: '#aa8855',
            dot: '#ffcc00',
            power: '#ff4444',
            gridLines: false,
            waveEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222211112222222222221",
            "1211111122211112221111111121",
            "1311111122211112221111111131",
            "1211111122222222221111111121",
            "1222222222211112222222222221",
            "1211111111211112111111112121",
            "1211111111211112111111112121",
            "1222211111211112111112222221",
            "1111211111200002111112111111",
            "0000211111200002111112000000",
            "0000222211200002112222000000",
            "0000211211144411121120000000",
            "1111211211400041121121111111",
            "5000222211400041122220000005",
            "1111211211400041121121111111",
            "0000211211111111121120000000",
            "0000222200000000022220000000",
            "0000211211111111121120000000",
            "1111211222222222222121111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111222222222222111111121",
            "1322222211111111112222222231",
            "1111111211111111112111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    DRAGON_CASTLE: {
        id: 'dragon_castle',
        name: 'Dragon Castle',
        icon: 'ðŸ°',
        description: 'Medieval fortress with fiery dangers',
        unlocked: true,
        unlockCondition: 'Score 30,000 points',
        theme: {
            background: '#110505',
            wall: '#aa4400',
            wallGlow: '#ff6600',
            dot: '#ffaa00',
            power: '#00ffff',
            gridLines: false,
            fireEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222221111111122222222221",
            "1211111121111111121111111121",
            "1311221121111111121122111131",
            "1211221122222222221122112121",
            "1222221111111111111122222221",
            "1211221111111111111122112121",
            "1211222211111111112222112121",
            "1211111211111111112111112121",
            "1111111211111111112111111111",
            "0000222211111111112222000000",
            "0000211211111111112112000000",
            "0000211211144411112112000000",
            "1111211211400041112112111111",
            "5000222211400041112222000005",
            "1111211211400041112112111111",
            "0000211211111111112112000000",
            "0000222222222222222222000000",
            "0000211211111111112112000000",
            "1111211222222222222112111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111222222222222111111121",
            "1322221111111111111122222231",
            "1111221111111111111122111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    LABORATORY: {
        id: 'laboratory',
        name: 'Laboratory',
        icon: 'ðŸ”¬',
        description: 'Scientific complex with experiments',
        unlocked: true,
        unlockCondition: 'Complete Story Chapter 2',
        theme: {
            background: '#0a0f0a',
            wall: '#44aa44',
            wallGlow: '#66ff66',
            dot: '#88ffff',
            power: '#ff88ff',
            gridLines: true,
            gridColor: 'rgba(68,170,68,0.1)',
            bubbleEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211112111112112111121112121",
            "1311112111112112111121112131",
            "1211112222222222222221112121",
            "1222222111111111111122222221",
            "1211112111111111111121112121",
            "1211112111111111111121112121",
            "1222222111111111111122222221",
            "1111112111100011111121111111",
            "0000022111100011111220000000",
            "0000022111100011111220000000",
            "0000022111144411111220000000",
            "1111122111400041111221111111",
            "5000222111400041111222000005",
            "1111122111400041111221111111",
            "0000022111111111111220000000",
            "0000022111100011111220000000",
            "0000022111100011111220000000",
            "1111112111111111111121111111",
            "1222222222222222222222222221",
            "1211112111112112111121112121",
            "1211112111112112111121112121",
            "1322222222222222222222222231",
            "1111112111111111111121111111",
            "1222222111111111111122222221",
            "1211112222212112222221112121",
            "1311112111112112111121112131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    UNDERWATER: {
        id: 'underwater',
        name: 'Underwater',
        icon: 'ðŸŒŠ',
        description: 'Deep sea adventure with sea creatures',
        unlocked: true,
        unlockCondition: 'Complete 20 levels',
        theme: {
            background: '#001a33',
            wall: '#0066aa',
            wallGlow: '#0088dd',
            dot: '#aaffff',
            power: '#ffff00',
            gridLines: false,
            bubbleEffect: true,
            causticEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1311111111111111111111111131",
            "1222222222222222222222222221",
            "1211112111122211111211112121",
            "1211112111122211111211112121",
            "1222222211122211112222222221",
            "1111111211122211112111111111",
            "0000002211100011112200000000",
            "0000002211100011112200000000",
            "0000002211100011112200000000",
            "0000002211144411112200000000",
            "1111112211400041112211111111",
            "5000222211400041112222000005",
            "1111112211400041112211111111",
            "0000002211111111112200000000",
            "0000002211100011112200000000",
            "0000002211100011112200000000",
            "1111111211122211112111111111",
            "1222222211122211112222222221",
            "1211112111122211111211112121",
            "1211112111122211111211112121",
            "1322222222222222222222222231",
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    VOLCANO: {
        id: 'volcano',
        name: 'Volcano',
        icon: 'ðŸŒ‹',
        description: 'Lava-filled dangers await',
        unlocked: true,
        unlockCondition: 'Survive 5 minutes in Survival mode',
        theme: {
            background: '#1a0500',
            wall: '#ff4400',
            wallGlow: '#ff8800',
            dot: '#ffcc00',
            power: '#00ffff',
            gridLines: false,
            lavaEffect: true,
            heatWave: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222112222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1211111111112112111111111121",
            "1222222211112112112222222221",
            "1211111211112112112111112121",
            "1211111211100001112111112121",
            "1222222211100001112222222221",
            "1111111211100001112111111111",
            "0000022211100001112220000000",
            "0000022200000000002220000000",
            "0000022201144410022220000000",
            "1111122201400040122211111111",
            "5000222201400040122220000005",
            "1111122201400040122211111111",
            "0000022201111110022220000000",
            "0000022200000000002220000000",
            "0000022211100001112220000000",
            "1111111211100001112111111111",
            "1222222211112112112222222221",
            "1211111211112112112111111121",
            "1211111211112112112111111121",
            "1322222222222222222222222231",
            "1111111111112112111111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    CLOCKWORK: {
        id: 'clockwork',
        name: 'Clockwork',
        icon: 'âš™ï¸',
        description: 'Moving mechanical parts challenge you',
        unlocked: true,
        unlockCondition: 'Complete Story Chapter 4',
        theme: {
            background: '#0f0f0a',
            wall: '#cc9933',
            wallGlow: '#ffcc66',
            dot: '#ffffff',
            power: '#ff4444',
            gridLines: false,
            gearEffect: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1311111211111111112111111131",
            "1211111222222222222111111121",
            "1222222211111111112222222221",
            "1211111211111111112111112121",
            "1211111211111111112111112121",
            "1222211211111111112112222221",
            "1111211200000000021121111111",
            "0000211200000000021120000000",
            "0000222200000000022220000000",
            "0000211201144410021120000000",
            "1111211201400040121121111111",
            "5000222201400040122220000005",
            "1111211201400040121121111111",
            "0000211201111110021120000000",
            "0000222200000000022220000000",
            "0000211211111111112120000000",
            "1111211222222222222121111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111222222222222111111121",
            "1322222211111111112222222231",
            "1111111211111111112111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    },

    RAINBOW_ROAD: {
        id: 'rainbow_road',
        name: 'Rainbow Road',
        icon: 'ðŸŒˆ',
        description: 'Colorful pathways through the sky',
        unlocked: true,
        unlockCondition: 'Complete all Story chapters',
        theme: {
            background: '#110022',
            wall: 'rainbow',
            wallGlow: 'rainbow',
            dot: '#ffffff',
            power: '#ffff00',
            gridLines: false,
            rainbowEffect: true,
            starField: true
        },
        layout: [
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1311111111111111111111111131",
            "1222222222222222222222222221",
            "1211111211111111112111112121",
            "1211111211111111112111112121",
            "1222211211111111112112222221",
            "1111211211111111112112111111",
            "0000211200000000002112000000",
            "0000222200000000002222000000",
            "0000211200000000002112000000",
            "0000211201144410021120000000",
            "1111211201400040121121111111",
            "5000222001400040022220000005",
            "1111211201400040121121111111",
            "0000211201111110021120000000",
            "0000222200000000002222000000",
            "0000211211111111112112000000",
            "1111211222222222222112111111",
            "1222222211111111112222222221",
            "1211111211111111112111111121",
            "1211111211111111112111111121",
            "1322222222222222222222222231",
            "1111111111111111111111111111",
            "1222222222222222222222222221",
            "1211111111112112111111111121",
            "1311111111112112111111111131",
            "1222222222222222222222222221",
            "1211111111111111111111111121",
            "1111111111111111111111111111"
        ]
    }
};

/**
 * Map Manager Class
 */
export class MapManager {
    constructor(game) {
        this.game = game;
        this.currentMap = MAPS.CLASSIC;
        this.unlockedMaps = this.loadUnlockedMaps();
    }

    loadUnlockedMaps() {
        const saved = localStorage.getItem('pacman_maps_unlocked');
        return saved ? JSON.parse(saved) : ['classic'];
    }

    saveUnlockedMaps() {
        localStorage.setItem('pacman_maps_unlocked', JSON.stringify(this.unlockedMaps));
    }

    unlockMap(mapId) {
        if (!this.unlockedMaps.includes(mapId)) {
            this.unlockedMaps.push(mapId);
            this.saveUnlockedMaps();
            return true;
        }
        return false;
    }

    setMap(mapId) {
        const map = MAPS[mapId.toUpperCase()] || Object.values(MAPS).find(m => m.id === mapId);
        if (map && (this.unlockedMaps.includes(map.id) || map.id === 'classic')) {
            this.currentMap = map;
            return true;
        }
        return false;
    }

    getCurrentLayout() {
        return this.currentMap.layout;
    }

    getCurrentTheme() {
        return this.currentMap.theme;
    }

    parseLayout() {
        const layout = this.currentMap.layout;
        const grid = [];
        let dotsCount = 0;

        for (let y = 0; y < layout.length; y++) {
            grid[y] = [];
            for (let x = 0; x < layout[y].length; x++) {
                const char = layout[y][x];
                const tile = parseInt(char);
                grid[y][x] = isNaN(tile) ? TILE.EMPTY : tile;

                if (tile === TILE.DOT || tile === TILE.POWER) {
                    dotsCount++;
                }
            }
        }

        return { grid, dotsCount };
    }

    getAllMaps() {
        return Object.values(MAPS).map(map => ({
            ...map,
            unlocked: this.unlockedMaps.includes(map.id) || map.id === 'classic'
        }));
    }

    isUnlocked(mapId) {
        return this.unlockedMaps.includes(mapId) || mapId === 'classic';
    }

    getWallColor(time = 0) {
        const theme = this.currentMap.theme;
        if (theme.wall === 'rainbow') {
            const hue = (time * 50) % 360;
            return `hsl(${hue}, 100%, 50%)`;
        }
        return theme.wall;
    }

    getWallGlow(time = 0) {
        const theme = this.currentMap.theme;
        if (theme.wallGlow === 'rainbow') {
            const hue = (time * 50) % 360;
            return `hsl(${hue}, 100%, 70%)`;
        }
        return theme.wallGlow;
    }
}
